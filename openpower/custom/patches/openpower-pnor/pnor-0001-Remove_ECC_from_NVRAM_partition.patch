From 961cca9e5280156c74e2ab0a29c7197c3c94f3ba Mon Sep 17 00:00:00 2001
From: Matt Ploetz <maploetz@us.ibm.com>
Date: Tue, 4 Apr 2017 11:26:03 -0500
Subject: [PATCH] Revert "Remove ECC from NVRAM partition"

This reverts commit 1edbc6dd09c3121468e373213fc56198b0ff22ff.
---
 create_pnor_image.pl                             | 2 +-
 p8Layouts/defaultPnorLayoutSingleSide.xml        | 1 +
 p8Layouts/defaultPnorLayoutWithGoldenSide.xml    | 1 +
 p8Layouts/defaultPnorLayoutWithoutGoldenSide.xml | 1 +
 update_image.pl                                  | 3 ++-
 5 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/create_pnor_image.pl b/create_pnor_image.pl
index c35e454..9541468 100755
--- a/create_pnor_image.pl
+++ b/create_pnor_image.pl
@@ -119,7 +119,7 @@
 $build_pnor_command .= " --binFile_GUARD $scratch_dir/guard.bin.ecc";
 $build_pnor_command .= " --binFile_PAYLOAD $payload";
 $build_pnor_command .= " --binFile_BOOTKERNEL $bootkernel";
-$build_pnor_command .= " --binFile_NVRAM $scratch_dir/nvram.bin";
+$build_pnor_command .= " --binFile_NVRAM $scratch_dir/nvram.bin.ecc";
 $build_pnor_command .= " --binFile_MVPD $scratch_dir/mvpd_fill.bin.ecc";
 $build_pnor_command .= " --binFile_DJVPD $scratch_dir/djvpd_fill.bin.ecc";
 $build_pnor_command .= " --binFile_CVPD $scratch_dir/cvpd.bin.ecc";
diff --git a/p8Layouts/defaultPnorLayoutSingleSide.xml b/p8Layouts/defaultPnorLayoutSingleSide.xml
index d96149e..388e4bb 100755
--- a/p8Layouts/defaultPnorLayoutSingleSide.xml
+++ b/p8Layouts/defaultPnorLayoutSingleSide.xml
@@ -196,6 +196,7 @@ Layout Description
         <physicalOffset>0x1961000</physicalOffset>
         <physicalRegionSize>0x90000</physicalRegionSize>
         <side>A</side>
+        <ecc/>
         <preserved/>
         <reprovision/>
     </section>
diff --git a/p8Layouts/defaultPnorLayoutWithGoldenSide.xml b/p8Layouts/defaultPnorLayoutWithGoldenSide.xml
index 1cd11ae..03cfb4e 100755
--- a/p8Layouts/defaultPnorLayoutWithGoldenSide.xml
+++ b/p8Layouts/defaultPnorLayoutWithGoldenSide.xml
@@ -232,6 +232,7 @@ Layout Description
         <physicalOffset>0x1DE2000</physicalOffset>
         <physicalRegionSize>0x90000</physicalRegionSize>
         <side>sideless</side>
+        <ecc/>
         <preserved/>
         <reprovision/>
     </section>
diff --git a/p8Layouts/defaultPnorLayoutWithoutGoldenSide.xml b/p8Layouts/defaultPnorLayoutWithoutGoldenSide.xml
index 893433a..46dbe1a 100755
--- a/p8Layouts/defaultPnorLayoutWithoutGoldenSide.xml
+++ b/p8Layouts/defaultPnorLayoutWithoutGoldenSide.xml
@@ -232,6 +232,7 @@ Layout Description
         <physicalRegionSize>0x90000</physicalRegionSize>
         <side>sideless</side>
         <preserved/>
+        <ecc/>
         <reprovision/>
     </section>
     <section>
diff --git a/update_image.pl b/update_image.pl
index c4ff02a..61e59e1 100755
--- a/update_image.pl
+++ b/update_image.pl
@@ -173,7 +173,8 @@
 run_command("ecc --inject $scratch_dir/hostboot.temp.bin --output $scratch_dir/guard.bin.ecc --p8");
 
 #Create blank binary file for NVRAM Data (NVRAM) Partition
-run_command("dd if=/dev/zero bs=512K count=1 of=$scratch_dir/nvram.bin");
+run_command("dd if=/dev/zero bs=512K count=1 | tr \"\\000\" \"\\377\" > $scratch_dir/hostboot.temp.bin");
+run_command("ecc --inject $scratch_dir/hostboot.temp.bin --output $scratch_dir/nvram.bin.ecc --p8");
 
 #Create blank binary file for MVPD Partition
 run_command("dd if=/dev/zero bs=512K count=1 | tr \"\\000\" \"\\377\" > $scratch_dir/hostboot.temp.bin");
