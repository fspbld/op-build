From b88904ea18bfec5544cbce1e55d60a37d227d01b Mon Sep 17 00:00:00 2001
From: Thi Tran <thi@us.ibm.com>
Date: Tue, 24 Jan 2017 10:44:33 -0600
Subject: [PATCH] SW376594: Loadline update for Garrison / Minsky

Change-Id: I70921886d65ff06627d0bfc088ae33a3bd31c63f
CQ:SW376594
Reviewed-on: http://ralgit01.raleigh.ibm.com/gerrit1/35337
Tested-by: Jenkins Server <pfd-jenkins+hostboot@us.ibm.com>
Tested-by: Jenkins OP Build CI <op-jenkins+hostboot@us.ibm.com>
Reviewed-by: Thi N. Tran <thi@us.ibm.com>
Tested-by: Jenkins OP HW <op-hw-jenkins+hostboot@us.ibm.com>
Tested-by: FSP CI Jenkins <fsp-CI-jenkins+hostboot@us.ibm.com>
Reviewed-by: Daniel M. Crowell <dcrowell@us.ibm.com>
---
 src/usr/hwpf/hwp/pstates/pstates/pstate_tables.c | 73 ++++++++++++++++++------
 src/usr/hwpf/hwp/pstates/pstates/pstates.h       | 10 +++-
 2 files changed, 65 insertions(+), 18 deletions(-)

diff --git a/src/usr/hwpf/hwp/pstates/pstates/pstate_tables.c b/src/usr/hwpf/hwp/pstates/pstates/pstate_tables.c
index 5518b39..2ef6656 100755
--- a/src/usr/hwpf/hwp/pstates/pstates/pstate_tables.c
+++ b/src/usr/hwpf/hwp/pstates/pstates/pstate_tables.c
@@ -5,7 +5,7 @@
 /*                                                                        */
 /* OpenPOWER HostBoot Project                                             */
 /*                                                                        */
-/* Contributors Listed Below - COPYRIGHT 2013,2015                        */
+/* Contributors Listed Below - COPYRIGHT 2013,2017                        */
 /* [+] International Business Machines Corp.                              */
 /*                                                                        */
 /*                                                                        */
@@ -22,7 +22,7 @@
 /* permissions and limitations under the License.                         */
 /*                                                                        */
 /* IBM_PROLOG_END_TAG                                                     */
-// $Id: pstate_tables.c,v 1.26 2015/08/20 17:04:06 stillgs Exp $
+// $Id: pstate_tables.c,v 1.27 2017/01/19 17:42:08 stillgs Exp $
 
 /// \file pstate_tables.c
 /// \brief This file contains code used to generate Pstate tables from real or
@@ -302,6 +302,27 @@ chip_characterization_create(ChipCharacterization *characterization,
                         ops[gpst_points].vdd_uv +              // Base Point with bias but no system effects
                         vdd_dist_uplift_uv +                   // Distribution loss based on apportioned current
                         parameters->vdd_voffset_uv;            // Offset present
+                        
+                    // -- SWfoobar Begin
+                    // Per analysis by the system characterization team, an 
+                    // additional uplift is needed if the number of cores is
+                    // below the maximum number of cores where a package uplift
+                    // is introduced.
+                    if (c < PACKAGE_DIST_UPLIFT_MAX_CORES)
+                    {
+                        printf("VDD set point voltage before package uplift for %d cores: ops[%d].vdd_corrected_wof_uv[%d] = %u"  TRACE_NEWLINE,
+                            c+1, gpst_points, c, ops[gpst_points].vdd_corrected_wof_uv[c]);
+                            
+                        ops[gpst_points].vdd_corrected_wof_uv[c] += PACKAGE_DIST_UPLIFT_VDD_UV;
+                        
+                    }
+                    else
+                    {
+                    printf("VDD set point voltage not modified for package uplift for %d cores (index = %d)"  TRACE_NEWLINE,
+                            c+1, c);
+                    }
+                    
+                    // -- SWfoobar End 
 
                     printf( "ops[%d].vdd_uv = %u "
                             "ratio = %f "
@@ -337,6 +358,27 @@ chip_characterization_create(ChipCharacterization *characterization,
                         ops[gpst_points].vcs_uv +              // Base Point with bias but no system effects
                         vcs_dist_uplift_uv +                   // Distribution loss based on apportioned current
                         parameters->vcs_voffset_uv;            // Offset present
+                    
+                    // -- SWfoobar Begin
+                    // Per analysis by the system characterization team, an 
+                    // additional uplift is needed if the number of cores is
+                    // below the maximum number of cores where a package uplift
+                    // is introduced.
+                    if (c < PACKAGE_DIST_UPLIFT_MAX_CORES)
+                    {
+                        printf("VCS set point voltage before package uplift for %d cores: ops[%d].vcs_corrected_wof_uv[%d] = %u"  TRACE_NEWLINE,
+                            c+1, gpst_points, c, ops[gpst_points].vcs_corrected_wof_uv[c]);
+                            
+                        ops[gpst_points].vcs_corrected_wof_uv[c] += PACKAGE_DIST_UPLIFT_VCS_UV;
+                        
+                    }
+                    else
+                    {
+                    printf("VCS set point voltage not modified for package uplift for %d cores (index = %d)"  TRACE_NEWLINE,
+                            c+1, c);
+                    }
+                    
+                    // -- SWfoobar End 
 
                     printf( "ops[%d].vcs_uv = %u "
                             "ratio = %f "
@@ -362,20 +404,19 @@ chip_characterization_create(ChipCharacterization *characterization,
                 }
             }
 
-            printf("gpst_points %u "
-                "ops[gpst_points].vdd_uv = %u "
-                "ops[gpst_points].vcs_uv = %u "
-                "ops[gpst_points].vdd_maxreg_uv = %u "
-                "ops[gpst_points].vcs_maxreg_uv = %u "
-                "ops[gpst_points].idd_ma = %u "
-                "ops[gpst_points].ics_ma = %u" TRACE_NEWLINE,
-                gpst_points,
-                ops[gpst_points].vdd_uv,
-                ops[gpst_points].vcs_uv,
-                ops[gpst_points].vdd_maxreg_uv,
-                ops[gpst_points].vcs_maxreg_uv,
-                ops[gpst_points].idd_ma,
-                ops[gpst_points].ics_ma);
+            printf("ops[%d].vdd_uv = %u "
+                "ops[%d].vcs_uv = %u "
+                "ops[%d].vdd_maxreg_uv = %u "
+                "ops[%d].vcs_maxreg_uv = %u "
+                "ops[%d].idd_ma = %u "
+                "ops[%d].ics_ma = %u" TRACE_NEWLINE,               
+                gpst_points, ops[gpst_points].vdd_uv,
+                gpst_points, ops[gpst_points].vcs_uv,
+                gpst_points, ops[gpst_points].vdd_maxreg_uv,
+                gpst_points, ops[gpst_points].vcs_maxreg_uv,
+                gpst_points, ops[gpst_points].idd_ma,
+                gpst_points, ops[gpst_points].ics_ma);
+                
             gpst_points++;
         }
 
diff --git a/src/usr/hwpf/hwp/pstates/pstates/pstates.h b/src/usr/hwpf/hwp/pstates/pstates/pstates.h
index fd0e876..ec77231 100755
--- a/src/usr/hwpf/hwp/pstates/pstates/pstates.h
+++ b/src/usr/hwpf/hwp/pstates/pstates/pstates.h
@@ -5,7 +5,7 @@
 /*                                                                        */
 /* OpenPOWER HostBoot Project                                             */
 /*                                                                        */
-/* Contributors Listed Below - COPYRIGHT 2013,2015                        */
+/* Contributors Listed Below - COPYRIGHT 2013,2017                        */
 /* [+] Google Inc.                                                        */
 /* [+] International Business Machines Corp.                              */
 /*                                                                        */
@@ -26,7 +26,7 @@
 #ifndef __PSTATES_H__
 #define __PSTATES_H__
 
-// $Id: pstates.h,v 1.14 2015/06/01 19:02:17 stillgs Exp $
+// $Id: pstates.h,v 1.15 2017/01/19 17:42:08 stillgs Exp $
 
 /// \file pstates.h
 /// \brief Pstate structures and support routines for OCC product firmware
@@ -101,6 +101,12 @@
 #define NUM_ACTIVE_CORES 12
 #define MAX_UT_PSTATES   64     // Oversized
 
+// -- SWfoobar Begin
+#define PACKAGE_DIST_UPLIFT_VDD_UV  12500
+#define PACKAGE_DIST_UPLIFT_VCS_UV  12500
+#define PACKAGE_DIST_UPLIFT_MAX_CORES  7    // This comes from emperical characterization data
+// -- SWfoobar End
+
 // Error/Panic codes for support routines
 
 #define VRM11_INVALID_VOLTAGE 0x00876101
