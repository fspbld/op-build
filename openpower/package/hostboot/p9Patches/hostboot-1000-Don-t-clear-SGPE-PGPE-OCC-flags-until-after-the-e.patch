From 7d0b0941c484ee1b1eb6c4f898713a88417a3020 Mon Sep 17 00:00:00 2001
From: Brian Vanderpool <vanderp@us.ibm.com>
Date: Thu, 28 Sep 2017 12:06:54 -0500
Subject: [PATCH v1] Don't clear SGPE/PGPE OCC flags until after the engines
 are halted

Change-Id: Id707a12d3e7dd00c310a01630a2e520b2ed22a6e
---
 src/import/chips/p9/procedures/hwp/pm/p9_pm_reset.C | 20 +++++++++++---------
 1 file changed, 11 insertions(+), 9 deletions(-)

diff --git a/src/import/chips/p9/procedures/hwp/pm/p9_pm_reset.C b/src/import/chips/p9/procedures/hwp/pm/p9_pm_reset.C
index d0f4456..a9037b7 100644
--- a/src/import/chips/p9/procedures/hwp/pm/p9_pm_reset.C
+++ b/src/import/chips/p9/procedures/hwp/pm/p9_pm_reset.C
@@ -95,15 +95,6 @@ fapi2::ReturnCode p9_pm_reset(
     FAPI_TRY(l_rc, "ERROR: Failed to mask OCC FIRs.");
     FAPI_TRY(p9_pm_glob_fir_trace(i_target, "After masking FIRs"));
 
-    // Clear the OCC Flag and Scratch2 registers
-    // which contain runtime settings and modes for PM GPEs (Pstate and Stop functions)
-    l_data64.flush<0>();
-    FAPI_TRY(fapi2::putScom(i_target, PU_OCB_OCI_OCCFLG_SCOM, l_data64),
-             "ERROR: Failed to write to OCC Flag Register");
-
-    FAPI_TRY(fapi2::putScom(i_target, PU_OCB_OCI_OCCS2_SCOM, l_data64),
-             "ERROR: Failed to write to OCC Scratch2 Register");
-
     //  ************************************************************************
     //  Halt the OCC PPC405 and reset it safely
     //  ************************************************************************
@@ -162,6 +153,17 @@ fapi2::ReturnCode p9_pm_reset(
     FAPI_TRY(p9_pm_glob_fir_trace(i_target, "After reset of SGPE"));
 
     //  ************************************************************************
+    // Clear the OCC Flag and Scratch2 registers
+    // which contain runtime settings and modes for PM GPEs (Pstate and Stop functions)
+    //  ************************************************************************
+    l_data64.flush<0>();
+    FAPI_TRY(fapi2::putScom(i_target, PU_OCB_OCI_OCCFLG_SCOM, l_data64),
+             "ERROR: Failed to write to OCC Flag Register");
+    FAPI_TRY(fapi2::putScom(i_target, PU_OCB_OCI_OCCS2_SCOM, l_data64),
+             "ERROR: Failed to write to OCC Scratch2 Register");
+
+
+    //  ************************************************************************
     //  Reset Cores and Quads
     //  ************************************************************************
     FAPI_DBG("Executing p9_pm_corequad_init to reset cores & quads");
-- 
1.8.2.2

