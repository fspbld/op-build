From 23619883340d268ab000180231a21f04d4242631 Mon Sep 17 00:00:00 2001
From: Dean Sanner <dsanner@us.ibm.com>
Date: Mon, 25 Sep 2017 21:48:35 -0500
Subject: [PATCH 1/2] Fix invalid pointer access in HBRT during PM Reset

Change-Id: I2fbe6876ec01da128ebc7282dfc879eb67690f68
---
 src/usr/util/utillidpnor.C | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/usr/util/utillidpnor.C b/src/usr/util/utillidpnor.C
index 48381e0..2bfe021 100644
--- a/src/usr/util/utillidpnor.C
+++ b/src/usr/util/utillidpnor.C
@@ -158,7 +158,16 @@ bool UtilLidMgr::getLidPnorSectionInfo(uint32_t i_lidId,
 #endif
 #endif
             // @TODO CQ:SW400352 remove this check
-            if ((l_secId == PNOR::OCC) && PNOR::isSectionEmpty(l_secId))
+            if ((l_secId == PNOR::OCC)
+#ifndef __HOSTBOOT_RUNTIME
+                && PNOR::isSectionEmpty(l_secId)
+#else
+                //use this check for HBRT due to secure lid load setting vaddr
+                //to zero -- which causes isSectionEmpty to segfault
+                && !o_lidPnorInfo.vaddr
+#endif
+                )
+            if ((l_secId == PNOR::OCC) && !o_lidPnorInfo.vaddr)
             {
                 UTIL_FT("UtilLidMgr::getLidPnorSection PNOR section %s is empty get data from LID transfer",
                         PNOR::SectionIdToString(l_secId));
@@ -170,4 +179,4 @@ bool UtilLidMgr::getLidPnorSectionInfo(uint32_t i_lidId,
     } while(0);
 
     return l_lidInPnor;
-}
\ No newline at end of file
+}
-- 
1.8.2.2

